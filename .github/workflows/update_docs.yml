name: Update ST Docs
on:
  schedule:
    - cron: '0 * * * *' # (Runs every hour)
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
permissions:
  contents: write
  pull-requests: write
jobs:
  update-knowledge-base:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Checkout Source Docs (SillyTavern-Docs)
        uses: actions/checkout@v4
        with:
          repository: SillyTavern/SillyTavern-Docs
          path: temp_source
      - name: Extract Upstream Commit Info
        id: upstream_info
        run: |
          cd temp_source
          # Get the short hash
          SHORT_HASH=$(git rev-parse --short HEAD)
          echo "HASH=$SHORT_HASH" >> $GITHUB_OUTPUT
          
          # Get the full commit message
          {
            echo 'MSG<<EOF'
            git log -1 --pretty=%B
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          cd ..

      - name: Process Docs
        run: |
          # 1. Set up temporary directory
          mkdir -p processed_temp
          
          echo "Processing Markdown files..."
          
          # 2. Flatten and Rename
          find temp_source -type f -name "*.md" | while read -r file; do
              clean_path="${file#temp_source/}"
              flat_name="${clean_path//\//_}"
              cp "$file" "processed_temp/SillyTavern_$flat_name"
          done
          
          # 3. Sanitize .md files
          cd processed_temp
          
          # Remove Redirect Stubs
          grep -rl "This page has been moved to" . | xargs -r rm
          
          # Remove YAML Front Matter
          find . -type f -name "*.md" -exec sed -i '1{/^---/!q;};1,/^---/d' {} +
          
          # Clean up "Ghost" Table rows (Only pipes and spaces)
          find . -type f -name "*.md" -exec sed -i -E '/^\|[[:space:]|]*\|$/d' {} +
          
          # Advanced Sanitization (Python)
          find . -type f -name "*.md" | while read -r file; do
            python3 -c "
          import re
          import sys
          
          filename = sys.argv[1]
          
          def replace_link(match):
              text = match.group(1)
              url = match.group(2)
              # Ignore external links
              if url.startswith('http') or url.startswith('www'):
                  return f'{text} ({url})'
              # Flatten internal links
              url = url.split('#')[0]
              clean_url = re.sub(r'^(\.|\.\.)?/', '', url)
              flat_name = clean_url.replace('/', '_')
              if flat_name and flat_name.endswith('.md'):
                  return f'[{text}](SillyTavern_{flat_name})'
              return text
          
          def replace_image(match):
              alt_text = match.group(1)
              # If alt text looks like a filename (e.g. image.png), discard it
              if re.search(r'\.(png|jpg|jpeg|gif|webp|svg)$', alt_text, re.IGNORECASE):
                  return ''
              return alt_text

          def replace_admonition(match):
              # Capture content after !!!type or !!! type
              content = match.group(2)
              return content if content else ''

          try:
              with open(filename, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # 1. Handle Images: ![Alt](url) -> Alt
              # Regex updated to handle optional spaces \s* and ensure it matches full syntax
              content = re.sub(r'!\[([^]]*)\]\s*\(([^)]*)\)', replace_image, content)
              
              # 2. Handle Links: [Text](url) -> [Text](SillyTavern_...)
              content = re.sub(r'\[([^]]+)\]\(([^)]+)\)', replace_link, content)
              
              # 3. Handle Admonitions: !!! type "Title" -> Title
              # Regex updated to handle optional space between !!! and type
              content = re.sub(r'^(?:!!!|:::)\s*(?:[a-zA-Z]+)?\s*(.*)$', replace_admonition, content, flags=re.MULTILINE)

              with open(filename, 'w', encoding='utf-8') as f:
                  f.write(content)
          except Exception as e:
              print(f'Error processing {filename}: {e}')
          " "$file"
          done
          
          # Remove <br> tags
          find . -type f -name "*.md" -exec sed -i -E 's/<br\s*\/?>//gi' {} +
          
          # Squeeze Whitespace
          find . -type f -name "*.md" | while read -r file; do
              cat -s "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"
          done
          
          cd ..

      - name: Push to Sync Branch
        id: push_to_sync
        env:
          UPSTREAM_MSG: ${{ steps.upstream_info.outputs.MSG }}
          UPSTREAM_HASH: ${{ steps.upstream_info.outputs.HASH }}
          TARGET_BRANCH: docs-sync
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          # Switch to sync branch (create if it doesn't exist)
          if git ls-remote --exit-code --heads origin $TARGET_BRANCH; then
            echo "Branch $TARGET_BRANCH exists, switching..."
            git checkout $TARGET_BRANCH
            git pull origin $TARGET_BRANCH
          else
            echo "Creating new branch $TARGET_BRANCH..."
            git checkout -b $TARGET_BRANCH
          fi

          # Clean old docs folder
          rm -rf docs
          mkdir docs
          
          # Move new files
          mv processed_temp/* docs/
          rm -rf processed_temp temp_source
          
          # Stage changes
          git add docs/
          
          # Check for changes and commit
          if git diff --staged --quiet; then
            echo "No changes. Workflow finished."
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            # Get current date
            DATE=$(date +'%Y-%m-%d')
            
            # Commit
            git commit -m "Sync: Docs Update $DATE" -m "$UPSTREAM_MSG" -m "Source Commit: https://github.com/SillyTavern/SillyTavern-Docs/commit/$UPSTREAM_HASH"
            
            # Push
            git push origin $TARGET_BRANCH
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Pull Request
        if: success() && steps.push_to_sync.outputs.HAS_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_MSG: ${{ steps.upstream_info.outputs.MSG }}
          UPSTREAM_HASH: ${{ steps.upstream_info.outputs.HASH }}
          TARGET_BRANCH: docs-sync
        run: |
          # Check if a PR from docs-sync to main already exists
          existing_pr=$(gh pr list --base main --head $TARGET_BRANCH --json url --jq '.[0].url')
          
          if [ -n "$existing_pr" ]; then
            echo "A PR already exists. Posting an update comment..."
            
            gh pr comment "$existing_pr" --body "ðŸš€ **Update Incoming!**
            
            The source documentation has changed again while this PR was open.
            I have automatically updated the files in this PR.
            
            **New Source Commit:** https://github.com/SillyTavern/SillyTavern-Docs/commit/$UPSTREAM_HASH
            
            **Changelog:**
            $UPSTREAM_MSG"
            
          else
            echo "Creating a new Pull Request..."
            DATE=$(date +'%Y-%m-%d')
            
            # Create the PR with Emoji Labels
            gh pr create \
              --base main \
              --head $TARGET_BRANCH \
              --title "Sync: Docs Update $DATE" \
              --label "ðŸ¤– Bot" \
              --label "ðŸ“š Documentation" \
              --label "ðŸ”„ Sync" \
              --body "$UPSTREAM_MSG
              Source Commit: https://github.com/SillyTavern/SillyTavern-Docs/commit/$UPSTREAM_HASH"
          fi
