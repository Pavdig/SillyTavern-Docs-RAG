name: Update ST Docs
on:
  schedule:
    - cron: '0 * * * *' # (Runs every hour)
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
permissions:
  contents: write
  pull-requests: write
jobs:
  update-knowledge-base:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Checkout Source Docs (SillyTavern-Docs)
        uses: actions/checkout@v4
        with:
          repository: SillyTavern/SillyTavern-Docs
          path: temp_source
      - name: Extract Upstream Commit Info
        id: upstream_info
        run: |
          cd temp_source
          SHORT_HASH=$(git rev-parse --short HEAD)
          echo "HASH=$SHORT_HASH" >> $GITHUB_OUTPUT
          {
            echo 'MSG<<EOF'
            git log -1 --pretty=%B
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          cd ..

      - name: Process Docs (Python Sanitization)
        run: |
          # 1. Prepare directories
          cp -r temp_source work_dir
          mkdir -p processed_temp
          
          echo "Running Python Sanitizer..."
          
          # 2. Run the Logic
            python3 -c "
          import re
          import os
          
          SOURCE_DIR = 'work_dir'
          OUTPUT_DIR = 'processed_temp'
          ROOT_DIR = 'work_dir'

          ADMONITION_TYPES = [
              'note', 'abstract', 'info', 'tip', 'success', 'question', 
              'warning', 'failure', 'danger', 'bug', 'example', 'quote', 'callout'
          ]
          
          def replace_link(match, file_path):
              text = match.group(1)
              url = match.group(2)
              
              if url.startswith('http') or url.startswith('www'):
                  return f'{text} ({url})'
              
              url = url.split('#')[0].split('?')[0]
              current_dir = os.path.dirname(file_path)
              
              try:
                  if url.startswith('/') or url.startswith('\\\\'):
                      abs_path = os.path.normpath(os.path.join(ROOT_DIR, url.lstrip('/\\\\')))
                  else:
                  abs_path = os.path.normpath(os.path.join(current_dir, url))
                  
                  rel_path = os.path.relpath(abs_path, ROOT_DIR)
              except ValueError:
                  return text 

              if rel_path.startswith('..'):
                  return text 
              
              flat_name = rel_path.replace(os.sep, '_')
              filename, ext = os.path.splitext(flat_name)
              if not ext:
                  flat_name += '.md'
              
              if flat_name.endswith('.yaml'):
                  flat_name = flat_name.replace('.yaml', '-yaml.md')
              
              if flat_name and (flat_name.endswith('.md') or flat_name.endswith('.json')):
                  return f'[{text}](SillyTavern_{flat_name})'
              
              return text
          
          def replace_image(match):
              return '' # Remove images to save tokens

          def replace_admonition(match):
              content = match.group(1).strip()
              if not content: return ''
              
              first_word = content.split(' ')[0]
              if first_word.lower() in ADMONITION_TYPES:
                  content = content[len(first_word):].strip()
                  
              if not content: return ''

              # If content is a Table or Code Block, do not bold it
              if content.startswith('|') or content.startswith('\`\`\`'):
                  return f'\n{content}\n'

              return f'\n**{content}**\n'

          print(f'Scanning {SOURCE_DIR}...')
          count = 0
          
          for root, dirs, files in os.walk(SOURCE_DIR):
              for filename in files:
                  if not filename.endswith('.md'): continue
                  
                  file_path = os.path.join(root, filename)

          try:
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
                      # Skip Redirect Stubs
                      if 'This page has been moved to' in content: continue

                      # Remove Front Matter
                      content = re.sub(r'^---\n.*?\n---\n', '', content, flags=re.DOTALL)

                      # Apply Regex
              content = re.sub(r'!\[((?:[^][]+|\[[^][]*\])*)\]\s*\(([^)]*)\)', replace_image, content)
                      content = re.sub(r'\[([^]]+)\]\(([^)]+)\)', lambda m: replace_link(m, file_path), content)
                      content = re.sub(r'^\s*(?:!!!|:::)\s*(.*)$', replace_admonition, content, flags=re.MULTILINE)
                      content = re.sub(r'^\s*\|[\s|]+\|\s*$', '', content, flags=re.MULTILINE) # Ghost Tables
                      content = re.sub(r'<br\s*\/?>', '', content, flags=re.IGNORECASE)
                      content = re.sub(r'\n{3,}', '\n\n', content) # Whitespace

                      # Determine Output Filename
                      rel_path = os.path.relpath(file_path, SOURCE_DIR)
                      flat_name = rel_path.replace(os.sep, '_')
                      out_path = os.path.join(OUTPUT_DIR, f'SillyTavern_{flat_name}')

                      with open(out_path, 'w', encoding='utf-8') as f:
                  f.write(content)
                      count += 1
          except Exception as e:
                      print(f'Error on {filename}: {e}')
          
          print(f'Processed {count} files.')
          "

          # Cleanup source
          rm -rf work_dir

      - name: Push to Sync Branch
        id: push_to_sync
        env:
          UPSTREAM_MSG: ${{ steps.upstream_info.outputs.MSG }}
          UPSTREAM_HASH: ${{ steps.upstream_info.outputs.HASH }}
          TARGET_BRANCH: docs-sync
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          if git ls-remote --exit-code --heads origin $TARGET_BRANCH; then
            echo "Branch $TARGET_BRANCH exists, switching..."
            git checkout $TARGET_BRANCH
            git pull origin $TARGET_BRANCH
          else
            echo "Creating new branch $TARGET_BRANCH..."
            git checkout -b $TARGET_BRANCH
          fi

          rm -rf docs
          mkdir docs
          mv processed_temp/* docs/
          rm -rf processed_temp temp_source
          
          git add docs/
          
          if git diff --staged --quiet; then
            echo "No changes. Workflow finished."
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            DATE=$(date +'%Y-%m-%d')
            git commit -m "Sync: Docs Update $DATE" -m "$UPSTREAM_MSG" -m "Source Commit: https://github.com/SillyTavern/SillyTavern-Docs/commit/$UPSTREAM_HASH"
            git push origin $TARGET_BRANCH
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Pull Request
        if: success() && steps.push_to_sync.outputs.HAS_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_MSG: ${{ steps.upstream_info.outputs.MSG }}
          UPSTREAM_HASH: ${{ steps.upstream_info.outputs.HASH }}
          TARGET_BRANCH: docs-sync
        run: |
          existing_pr=$(gh pr list --base main --head $TARGET_BRANCH --json url --jq '.[0].url')
          
          if [ -n "$existing_pr" ]; then
            echo "A PR already exists. Posting an update comment..."
            
            gh pr comment "$existing_pr" --body "ðŸš€ **Update Incoming!**
            
            The source documentation has changed again while this PR was open.
            I have automatically updated the files in this PR.
            
            **New Source Commit:** https://github.com/SillyTavern/SillyTavern-Docs/commit/$UPSTREAM_HASH
            
            **Changelog:**
            $UPSTREAM_MSG"
            
          else
            echo "Creating a new Pull Request..."
            DATE=$(date +'%Y-%m-%d')
            
            # Create the PR with Emoji Labels
            gh pr create \
              --base main \
              --head $TARGET_BRANCH \
              --title "Sync: Docs Update $DATE" \
              --label "ðŸ¤– Bot" \
              --label "ðŸ“š Documentation" \
              --label "ðŸ”„ Sync" \
              --body "$UPSTREAM_MSG
              Source Commit: https://github.com/SillyTavern/SillyTavern-Docs/commit/$UPSTREAM_HASH"
          fi