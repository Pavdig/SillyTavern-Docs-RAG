name: Update ST Docs to Staging

on:
  schedule:
    - cron: '0 * * * *' # (Runs every hour)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-knowledge-base:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to switch branches

      - name: Checkout Source Docs (SillyTavern)
        uses: actions/checkout@v4
        with:
          repository: SillyTavern/SillyTavern-Docs
          path: temp_source

      - name: Extract Upstream Commit Info
        id: upstream_info
        run: |
          cd temp_source
          # Get the short hash
          SHORT_HASH=$(git rev-parse --short HEAD)
          echo "HASH=$SHORT_HASH" >> $GITHUB_OUTPUT
          
          # Get the full commit message (Subject + Body) for the "Review Copy"
          # Special syntax to handle multiline strings in GitHub Actions
          {
            echo 'MSG<<EOF'
            git log -1 --pretty=%B
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          cd ..

      - name: Process Docs
        run: |
          # 1. Set up temporary staging directory
          mkdir -p processed_temp
          
          echo "Processing Markdown files..."
          
          # 2. Flatten and Rename
          find temp_source -type f -name "*.md" | while read -r file; do
              clean_path="${file#temp_source/}"
              flat_name="${clean_path//\//_}"
              cp "$file" "processed_temp/SillyTavern_$flat_name"
          done

          # 3. Sanitize .md files
          cd processed_temp
          
          # Remove Redirect Stubs
          grep -rl "This page has been moved to" . | xargs -r rm
          
          # Remove Front Matter
          find . -type f -name "*.md" -exec sed -i '1{/^---/!q;};1,/^---/d' {} +
          
          # Remove Admonitions tags
          find . -type f -name "*.md" -exec sed -i '/^!!!/d; /^:::/d' {} +
          
          # Remove Images
          find . -type f -name "*.md" -exec sed -i -E 's/!\[[^]]*\]\([^)]*\)//g' {} +
          
          # Unwrap Links
          find . -type f -name "*.md" -exec sed -i -E 's/\[([^]]*)\]\([^)]*\)/\1/g' {} +
          
          cd ..
          
      - name: Push to Staging Branch
        env:
          # We pass these as environment variables to safely handle special characters/quotes
          UPSTREAM_MSG: ${{ steps.upstream_info.outputs.MSG }}
          UPSTREAM_HASH: ${{ steps.upstream_info.outputs.HASH }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # Switch to staging branch (create if it doesn't exist)
          if git ls-remote --exit-code --heads origin staging; then
            echo "Staging branch exists, switching..."
            git checkout staging
            git pull origin staging
          else
            echo "Creating new staging branch..."
            git checkout -b staging
          fi
          
          # Clean old docs folder in the STAGING branch
          rm -rf docs
          mkdir docs
          
          # Move new files from our temp folder to the docs folder
          mv processed_temp/* docs/
          rm -rf processed_temp temp_source
          
          # Stage changes
          git add docs/
          
          # Check for changes and commit
          if git diff --staged --quiet; then
            echo "No changes detected from upstream. Workflow finished."
          else
            # Get current date for the clean title
            DATE=$(date +'%Y-%m-%d')
            
            # Commit with a clean title and move details to the body
            # -m 1: The Title (e.g., "Sync: Docs Update 2026-01-13")
            # -m 2: The Body (The full upstream commit message)
            # -m 3: The Footer (Source hash)
            git commit -m "Sync: Docs Update $DATE" -m "$UPSTREAM_MSG" -m "Source Commit: https://github.com/SillyTavern/SillyTavern-Docs/commit/$UPSTREAM_HASH"
            
            # Push to staging
            git push origin staging
          fi
